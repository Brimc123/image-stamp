from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse

app = FastAPI()

# adjust these to your real values (or keep your existing constants)
MIN_TOPUP_CREDITS = 100
CREDIT_COST_GBP = 0.25

BILLING_HTML_TMPL = """<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Billing</title>
  <style>
    :root {{ --brand: #4f46e5; --bg: #0b0b12; --card: #111827; --fg: #e5e7eb; }}
    * {{ box-sizing: border-box; }}
    body {{ margin: 0; padding: 24px; background: var(--bg); color: var(--fg);
           font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
                        Cantarell, 'Helvetica Neue', 'Noto Sans', Arial, sans-serif; }}
    .card {{ max-width: 720px; margin: 0 auto; background: var(--card);
            border-radius: 12px; padding: 24px; }}
    h1 {{ margin: 0 0 12px; font-size: 1.5rem; }}
    p  {{ margin: 0 0 16px; line-height: 1.5; }}
    .actions {{ display: flex; gap: 8px; }}
    button {{ background: var(--brand); color: #fff; border: 0; padding: 12px 16px;
              border-radius: 8px; cursor: pointer; font-weight: 600; }}
    input[type="number"] {{ width: 120px; padding: 10px; border-radius: 8px; border: 1px solid #374151;
                           background: #0f172a; color: var(--fg); }}
  </style>
</head>
<body>
  <div class="card">
    <h1>Top-up credits</h1>
    <p>Minimum top-up: <strong>{MIN}</strong> credits @ £{GBP:.2f} each
       (minimum total £{MIN_TOTAL:.2f}).</p>

    <div class="actions">
      <label for="qty" style="display:none">Credits</label>
      <input id="qty" type="number" min="{MIN}" value="{MIN}" />
      <button id="buy">Buy credits</button>
    </div>

    <p id="summary"></p>
  </div>

  <script>
    const GBP = {GBP};
    const MIN = {MIN};
    const summary = document.getElementById('summary');
    const qty = document.getElementById('qty');
    const buy = document.getElementById('buy');

    function fmt(n) {{ return new Intl.NumberFormat('en-GB', {{ minimumFractionDigits: 2 }}).format(n); }}
    function update() {{
      const q = Math.max(MIN, Number(qty.value) || 0);
      const total = q * GBP;
      summary.textContent = `You’re buying ${'{'}q{'}'} credits for £${'{'}fmt(total){'}'}.`;
    }}
    qty.addEventListener('input', update);
    update();

    buy.addEventListener('click', () => {{
      const q = Math.max(MIN, Number(qty.value) || 0);
      alert(`(demo) Charge £${'{'}fmt(q * GBP){'}'} for ${'{'}q{'}'} credits`);
      // TODO: call your backend to create a payment intent/session
    }});
  </script>
</body>
</html>
"""

@app.get("/billing", response_class=HTMLResponse)
def billing_page(request: Request):
    html = BILLING_HTML_TMPL.format(
        MIN=MIN_TOPUP_CREDITS,
        GBP=CREDIT_COST_GBP,
        MIN_TOTAL=MIN_TOPUP_CREDITS * CREDIT_COST_GBP,
    )
    return HTMLResponse(html)


@app.get("/health")
def health():
    return {"ok": True}
